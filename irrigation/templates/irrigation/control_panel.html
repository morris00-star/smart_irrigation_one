{% extends 'irrigation/base.html' %}
{% block title %}Control Panel{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header Section -->
    <header class="bg-green-600 text-white shadow">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold">Intelligent Irrigation Control Panel</h1>
            <p class="mt-1 text-green-100">Complete system monitoring and control</p>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Control Cards -->
            <div class="lg:col-span-1 space-y-6">
                <!-- System Status Card -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">System Status</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-2" id="system-status-indicator"></div>
                                <span class="text-gray-700">System:</span>
                                <span class="text-purple-700 ml-1 font-medium" id="system-status">Online</span>
                            </div>
                            <span class="text-sm text-gray-500" id="last-updated">Just now</span>
                        </div>

                        <div class="pt-4 border-t border-gray-200 space-y-2">
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>ESP32 Connection:</span>
                                <span class="font-medium" id="esp32-status">Checking...</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Operation Mode:</span>
                                <span class="font-medium" id="system-mode">Auto</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Emergency Status:</span>
                                <span class="font-medium" id="emergency-status">Inactive</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Current Threshold:</span>
                                <span class="text-yellow-700 font-medium" id="current-threshold-display">--%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Control Button -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button id="toggle-mode" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span id="mode-button-text">Switch to Manual</span>
                        </button>
                    </div>
                </div>

                <!-- Crop & Soil Configuration Card -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Crop & Soil Configuration</h2>

                    <!-- Current Configuration Status -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-md">
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-800">Current Crop:</span>
                            <span class="text-yellow-800 font-medium" id="current-crop-display">Not set</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-800">Current Soil:</span>
                            <span class="text-yellow-800 font-medium" id="current-soil-display">Not set</span>
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Crop Type</label>
                            <select id="crop-type" class="text-yellow-500 w-full rounded-md border-yellow-700 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200">
                                <option value="">Select a crop</option>
                                <option value="banana">Banana</option>
                                <option value="maize">Maize</option>
                                <option value="beans">Beans</option>
                                <option value="coffee">Coffee</option>
                                <option value="cassava">Cassava</option>
                                <option value="rice">Rice</option>
                                <option value="tomato">Tomato</option>
                                <option value="potato">Potato</option>
                                <option value="sugarcane">Sugarcane</option>
                                <option value="vegetables">Vegetables</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Soil Type</label>
                            <select id="soil-type" class="text-yellow-500 w-full rounded-md border-yellow-700  focus:ring focus:ring-green-200">
                                <option value="">Select soil type</option>
                                <option value="clay">Clay</option>
                                <option value="loamy">Loamy</option>
                                <option value="sandy">Sandy</option>
                            </select>
                        </div>
                        <button id="save-config" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Save Configuration
                        </button>
                    </div>
                </div>

                <!-- Threshold Control Card -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Threshold Control</h2>
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-700">Set Threshold:</span>
                            <span class="text-yellow-400 font-bold" id="current-threshold">--%</span>
                        </div>
                        <div class="relative pt-1">
                            <input type="range" min="0" max="100" value="30"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-green-500"
                                   id="threshold-slider">
                        </div>
                        <div class="mt-2 text-sm text-gray-600" id="threshold-suggestion">
                            Select crop and soil type for personalized recommendations.
                        </div>
                        <button id="use-recommended" class="mt-2 w-full bg-blue-100 hover:bg-blue-200 text-blue-800 py-1 px-4 rounded transition-colors text-sm">
                            Use Recommended Threshold
                        </button>
                    </div>
                    <div class="flex justify-between">
                        <button id="decrease-threshold" class="bg-gray-400 hover:bg-gray-700 text-gray-800 py-1 px-3 rounded transition-colors">
                            -5%
                        </button>
                        <button id="set-threshold" class="bg-green-600 hover:bg-green-700 text-white py-1 px-4 rounded transition-colors">
                            Set Threshold
                        </button>
                        <button id="increase-threshold" class="bg-gray-400 hover:bg-gray-700 text-gray-800 py-1 px-3 rounded transition-colors">
                            +5%
                        </button>
                    </div>
                </div>

                <!-- Manual Control Card -->
                <div id="manual-control-card" class="bg-white shadow rounded-lg p-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Manual Control</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Water Pump:</span>
                            <button id="toggle-pump" class="bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded transition-colors">
                                Turn ON
                            </button>
                        </div>
                        <div class="pt-2 border-t border-gray-200 text-xs text-gray-800">
                            Note: Manual controls are only active in manual mode.
                        </div>
                    </div>
                </div>

                <!-- Schedule Irrigation Card -->
                <div class="bg-white shadow rounded-lg p-6" id="scheduling-card">
                    <h2 class="text-xl font-bold mb-6 text-gray-900">Schedule Irrigation</h2>
                    <div id="scheduling-disabled-message" class="text-red-700 hidden scheduling-disabled-message">
                        Scheduling is only available in manual mode when no emergency is active
                    </div>
                    <div class="space-y-4" id="scheduling-form">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="schedule-date"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200"
                                   min="{{ now|date:'Y-m-d' }}">
                            <p class="mt-1 text-xs text-red-600 hidden" id="date-error">Please select a valid date</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <input type="time" id="schedule-time"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200">
                            <p class="mt-1 text-xs text-red-600 hidden" id="time-error">Please select a valid time</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes)</label>
                            <input type="number" id="schedule-duration" min="1" max="120" value="15"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200">
                            <p class="mt-1 text-xs text-red-600 hidden" id="duration-error">Duration must be between 1-120 minutes</p>
                        </div>
                        <div id="scheduled-events" class="hidden">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Upcoming Scheduled Events</h3>
                            <div id="events-list" class="space-y-2"></div>
                        </div>
                        <button id="schedule-irrigation" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Schedule Irrigation
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column - Monitoring -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Moisture Monitoring Card -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Soil Moisture Monitoring</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Current Moisture:</span>
                                <span class=" text-pink-700 font-bold" id="moisture-level">--%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-1">
                                <div id="moisture-bar" class="bg-green-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Dry</span>
                                <span>Optimal</span>
                                <span>Wet</span>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm text-gray-700">Status:</span>
                                    <span class="text-sm font-medium" id="moisture-status">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-700">Last Watering:</span>
                                    <span class="text-sm" id="last-watering">--</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-700">Device Status:</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        <span class="text-gray-700">Water Pump:</span>
                                        <span class="ml-2 font-medium" id="pump-status">OFF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Activity Logs Card -->
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">User Activity Logs</h2>
                        <div class="flex space-x-2">
                            <button id="export-logs-confirm" class="text-sm text-gray-500 hover:text-gray-700 transition-colors flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export Logs
                            </button>
                        </div>
                    </div>

                    <div id="user-activity-logs" class="h-64 overflow-y-auto p-3 bg-gray-50 rounded-md text-sm font-mono space-y-1"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Export Logs Modal -->
    <div id="export-modal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Export Activity Logs</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">Are you sure you want to export the user activity logs to Excel format?</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="confirm-export" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Export
                    </button>
                    <button id="cancel-export" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// System State Management
const systemState = {
    pump: false,
    moisture: 0,
    threshold: 30,
    lastUpdated: new Date(),
    esp32Connected: false,
    systemMode: 'auto',
    emergency: false,
    lastWateringTime: null
};

// User Activity Logs
let userActivityLogs = [];

// DOM Elements Reference
const elements = {
    // Status Elements
    systemStatus: document.getElementById('system-status'),
    systemStatusIndicator: document.getElementById('system-status-indicator'),
    esp32Status: document.getElementById('esp32-status'),
    lastUpdated: document.getElementById('last-updated'),
    systemMode: document.getElementById('system-mode'),
    emergencyStatus: document.getElementById('emergency-status'),
    currentThresholdDisplay: document.getElementById('current-threshold-display'),

    // Mode Control
    toggleMode: document.getElementById('toggle-mode'),
    modeButtonText: document.getElementById('mode-button-text'),

    // Manual Control
    manualControlCard: document.getElementById('manual-control-card'),
    togglePump: document.getElementById('toggle-pump'),

    // Moisture Monitoring
    moistureLevel: document.getElementById('moisture-level'),
    moistureBar: document.getElementById('moisture-bar'),
    moistureStatus: document.getElementById('moisture-status'),
    lastWatering: document.getElementById('last-watering'),

    // Device Status
    pumpStatus: document.getElementById('pump-status'),

    // Threshold Control
    currentThreshold: document.getElementById('current-threshold'),
    thresholdSlider: document.getElementById('threshold-slider'),
    decreaseThreshold: document.getElementById('decrease-threshold'),
    setThreshold: document.getElementById('set-threshold'),
    increaseThreshold: document.getElementById('increase-threshold'),

    // Schedule Irrigation
    scheduleDate: document.getElementById('schedule-date'),
    scheduleTime: document.getElementById('schedule-time'),
    scheduleDuration: document.getElementById('schedule-duration'),
    scheduleIrrigation: document.getElementById('schedule-irrigation'),
    scheduledEvents: document.getElementById('scheduled-events'),
    eventsList: document.getElementById('events-list'),
    dateError: document.getElementById('date-error'),
    timeError: document.getElementById('time-error'),
    durationError: document.getElementById('duration-error'),

    // User Activity Logs
    userActivityLogs: document.getElementById('user-activity-logs'),
    exportLogsConfirm: document.getElementById('export-logs-confirm'),

    // Export Modal
    exportModal: document.getElementById('export-modal'),
    confirmExport: document.getElementById('confirm-export'),
    cancelExport: document.getElementById('cancel-export'),

    // Crop/Soil Configuration
    cropType: document.getElementById('crop-type'),
    soilType: document.getElementById('soil-type'),
    saveConfig: document.getElementById('save-config'),
    thresholdSuggestion: document.getElementById('threshold-suggestion'),
    useRecommended: document.getElementById('use-recommended'),
    currentCropDisplay: document.getElementById('current-crop-display'),
    currentSoilDisplay: document.getElementById('current-soil-display'),
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    fetchSystemStatus();
    loadConfiguration();
    setInterval(fetchSystemStatus, 3000);
    logUserActivity("Control panel initialized");
    loadScheduledEvents();
    setDefaultScheduleTime();
});

// Core Functions
function setupEventListeners() {
    // Mode Control
    elements.toggleMode.addEventListener('click', toggleSystemMode);

    // Manual Controls
    elements.togglePump.addEventListener('click', togglePump);

    // Threshold controls
    elements.thresholdSlider.addEventListener('input', updateThresholdPreview);
    elements.decreaseThreshold.addEventListener('click', () => adjustThreshold(-5));
    elements.setThreshold.addEventListener('click', setThresholdFromSlider);
    elements.increaseThreshold.addEventListener('click', () => adjustThreshold(5));
    elements.saveConfig.addEventListener('click', saveConfiguration);
    elements.useRecommended.addEventListener('click', useRecommendedThreshold);

    // Initialize scheduling system
    function initScheduling() {
        resetScheduleForm();
        loadScheduledEvents();  // Load existing schedules

        // Add event listeners
        elements.scheduleIrrigation.addEventListener('click', function(e) {
            e.preventDefault();
            handleScheduleAction();
        });

        const cancelBtn = document.getElementById('cancel-schedule');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', resetScheduleForm);
        }
    }

    // Schedule button
    elements.scheduleIrrigation.addEventListener('click', handleScheduleAction);

    // Logs Export
    elements.exportLogsConfirm.addEventListener('click', showExportModal);
    elements.confirmExport.addEventListener('click', exportLogsToExcel);
    elements.cancelExport.addEventListener('click', hideExportModal);
}

// System Control Functions
async function toggleSystemMode() {
    const newMode = systemState.systemMode === 'auto' ? 'manual' : 'auto';
    const modeName = newMode === 'manual' ? 'Manual' : 'Auto';

    try {
        const response = await fetch('/api/control/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                action: 'set_mode',
                manual_mode: newMode === 'manual'
            })
        });

        if (!response.ok) throw new Error(`Server returned ${response.status}`);

        const data = await response.json();
        if (data.manual_mode !== undefined) {
            systemState.systemMode = data.manual_mode ? 'manual' : 'auto';
            updateSystemModeDisplay();
            logUserActivity(`User switched system to ${modeName} mode`);
        }
    } catch (error) {
        console.error('Error changing system mode:', error);
        logUserActivity(`Failed to switch to ${modeName} mode: ${error.message}`, "error");
    }
}

async function togglePump() {
    const newState = !systemState.pump;
    const action = newState ? 'activate' : 'deactivate';

    if (systemState.systemMode !== 'manual' || systemState.emergency) {
        logUserActivity("Attempt to control pump failed - must be in manual mode", "warning");
        return;
    }

    try {
        const response = await fetch('/api/control/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                action: 'toggle_pump',
                state: newState
            })
        });

        if (!response.ok) throw new Error(`Server returned ${response.status}`);

        const data = await response.json();
        if (data.pump !== undefined) {
            updateDeviceStatus('pump', data.pump);
            logUserActivity(`Pump ${action}d`);
        }
    } catch (error) {
        console.error('Error toggling pump:', error);
        logUserActivity(`Failed to ${action} pump: ${error.message}`, "error");
    }
}

// Configuration Management
async function loadConfiguration() {
    try {
        const response = await fetch('/api/get_config/');
        if (!response.ok) throw new Error('Failed to load configuration');

        const data = await response.json();

        // Update form fields
        if (data.crop) {
            elements.cropType.value = data.crop;
            elements.currentCropDisplay.textContent = data.crop.charAt(0).toUpperCase() + data.crop.slice(1);
        }
        if (data.soil) {
            elements.soilType.value = data.soil;
            elements.currentSoilDisplay.textContent = data.soil.charAt(0).toUpperCase() + data.soil.slice(1);
        }
        if (data.threshold) {
            elements.thresholdSlider.value = data.threshold;
            updateThresholdPreview();
        }

        // Update threshold suggestion
        if (data.threshold_suggestion) {
            elements.thresholdSuggestion.textContent = data.threshold_suggestion;
        }

    } catch (error) {
        console.error('Error loading configuration:', error);
        logUserActivity('Failed to load configuration', 'error');
    }
}

async function saveConfiguration() {
    const crop = elements.cropType.value;
    const soil = elements.soilType.value;

    if (!crop || !soil) {
        logUserActivity('Please select both crop and soil type', 'warning');
        showToast('Please select both crop and soil type', 'warning');
        return;
    }

    try {
        // Show loading state
        elements.saveConfig.disabled = true;
        elements.saveConfig.innerHTML = `
            <svg class="animate-spin h-5 w-5 mr-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Saving...
        `;

        const response = await fetch('/api/save_config/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                crop: crop,
                soil: soil
            })
        });

        if (!response.ok) throw new Error('Failed to save configuration');

        const data = await response.json();

        // Update display
        elements.currentCropDisplay.textContent = crop.charAt(0).toUpperCase() + crop.slice(1);
        elements.currentSoilDisplay.textContent = soil.charAt(0).toUpperCase() + soil.slice(1);
        elements.thresholdSuggestion.textContent = data.threshold_suggestion;

        logUserActivity('Configuration saved successfully');
        showToast('Configuration saved successfully', 'success');

    } catch (error) {
        console.error('Error saving configuration:', error);
        logUserActivity('Failed to save configuration', 'error');
        showToast('Failed to save configuration', 'error');
    } finally {
        // Restore button state
        elements.saveConfig.disabled = false;
        elements.saveConfig.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Save Configuration
        `;
    }
}

// Threshold Management
function updateThresholdPreview() {
    elements.currentThreshold.textContent = `${elements.thresholdSlider.value}%`;
}

function adjustThreshold(amount) {
    const current = parseInt(elements.thresholdSlider.value);
    const newValue = Math.min(100, Math.max(0, current + amount));
    elements.thresholdSlider.value = newValue;
    updateThresholdPreview();
}

function setThresholdFromSlider() {
    const newThreshold = parseInt(elements.thresholdSlider.value);
    setThreshold(newThreshold);
}

async function setThreshold(threshold) {
    try {
        const response = await fetch('/api/control/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                action: 'set_threshold',
                threshold: threshold
            })
        });

        if (!response.ok) throw new Error(`Failed to set threshold: ${response.status}`);

        const data = await response.json();
        systemState.threshold = data.threshold;
        elements.currentThreshold.textContent = `${data.threshold}%`;
        elements.thresholdSlider.value = data.threshold;
        elements.currentThresholdDisplay.textContent = `${data.threshold}%`;
        logUserActivity(`User set moisture threshold to ${data.threshold}%`);
        updateMoistureBarColor();
    } catch (error) {
        console.error('Error setting threshold:', error);
        logUserActivity(`Failed to set threshold: ${error.message}`, "error");
    }
}

async function useRecommendedThreshold() {
    try {
        const response = await fetch('/api/get_config/');
        if (!response.ok) throw new Error('Failed to get recommended threshold');

        const data = await response.json();

        if (data.recommended_threshold) {
            await setThreshold(data.recommended_threshold);
            logUserActivity(`Applied recommended threshold of ${data.recommended_threshold}%`);
            showToast(`Applied recommended threshold: ${data.recommended_threshold}%`, 'success');
        } else {
            throw new Error('No recommended threshold available');
        }

    } catch (error) {
        console.error('Error using recommended threshold:', error);
        logUserActivity('Failed to apply recommended threshold', 'error');
        showToast('Failed to apply recommended threshold', 'error');
    }
}

// UI Update Functions
function updateSystemModeDisplay() {
    elements.systemMode.textContent = systemState.systemMode.charAt(0).toUpperCase() + systemState.systemMode.slice(1);
    elements.modeButtonText.textContent = systemState.systemMode === 'auto' ? 'Switch to Manual' : 'Switch to Auto';

    if (systemState.systemMode === 'auto') {
        elements.toggleMode.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        elements.toggleMode.classList.add('bg-blue-600', 'hover:bg-blue-700');
        elements.manualControlCard.classList.add('hidden');
    } else {
        elements.toggleMode.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        elements.toggleMode.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        if (!systemState.emergency) {
            elements.manualControlCard.classList.remove('hidden');
        }
    }
}

function updateDeviceStatus(deviceType, state) {
    const isOn = state === 'on' || state === true;
    const statusElement = elements[`${deviceType}Status`];
    const displayValue = isOn ? 'ON' : 'OFF';

    if (statusElement) {
        statusElement.textContent = displayValue;
        statusElement.className = isOn ?
            'ml-2 font-medium text-green-600' :
            'ml-2 font-medium text-red-600';
    }

    systemState[deviceType] = isOn;
    updateManualControlButtons();
}

function updateManualControlButtons() {
    elements.togglePump.textContent = systemState.pump ? 'Turn OFF' : 'Turn ON';
    elements.togglePump.className = systemState.pump ?
        'bg-green-600 hover:bg-green-700 text-white py-1 px-4 rounded transition-colors' :
        'bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded transition-colors';
}

function updateConnectionStatus(connected) {
    systemState.esp32Connected = connected;
    elements.esp32Status.textContent = connected ? 'Connected' : 'Disconnected';
    elements.esp32Status.className = connected ? 'font-medium text-green-600' : 'font-medium text-red-600';

    if (connected) {
        elements.systemStatus.textContent = 'Online';
        elements.systemStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
    } else {
        elements.systemStatus.textContent = 'Offline';
        elements.systemStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
    }
}

function updateMoistureDisplay(moisture) {
    elements.moistureLevel.textContent = `${moisture}%`;
    elements.moistureBar.style.width = `${moisture}%`;

    if (moisture < systemState.threshold - 10) {
        elements.moistureStatus.textContent = "Too Dry";
        elements.moistureStatus.className = "text-sm font-medium text-red-600";
    } else if (moisture > systemState.threshold + 10) {
        elements.moistureStatus.textContent = "Too Wet";
        elements.moistureStatus.className = "text-sm font-medium text-blue-600";
    } else {
        elements.moistureStatus.textContent = "Optimal";
        elements.moistureStatus.className = "text-sm font-medium text-green-600";
    }

    updateMoistureBarColor();
}

function updateMoistureBarColor() {
    const moisture = systemState.moisture;
    const threshold = systemState.threshold;

    if (moisture < threshold - 10) {
        elements.moistureBar.className = 'bg-red-500 h-4 rounded-full transition-all duration-500';
    } else if (moisture > threshold + 10) {
        elements.moistureBar.className = 'bg-blue-500 h-4 rounded-full transition-all duration-500';
    } else {
        elements.moistureBar.className = 'bg-green-600 h-4 rounded-full transition-all duration-500';
    }
}

// Activity Log Functions
function logUserActivity(message, type = "info") {
    const timestamp = new Date();
    const logEntry = {
        timestamp: timestamp,
        message: message,
        type: type
    };

    userActivityLogs.push(logEntry);
    updateActivityLogDisplay();

    // Keep only the last 100 logs
    if (userActivityLogs.length > 100) {
        userActivityLogs.shift();
    }
}

function updateActivityLogDisplay() {
    elements.userActivityLogs.innerHTML = '';
    userActivityLogs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = `flex justify-between ${log.type === "error" ? 'text-red-600' :
                             log.type === "warning" ? 'text-yellow-600' : 'text-gray-800'}`;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'text-gray-500 mr-2';
        timeSpan.textContent = log.timestamp.toLocaleTimeString();

        const messageSpan = document.createElement('span');
        messageSpan.textContent = log.message;

        logEntry.appendChild(timeSpan);
        logEntry.appendChild(messageSpan);
        elements.userActivityLogs.appendChild(logEntry);
    });

    elements.userActivityLogs.scrollTop = elements.userActivityLogs.scrollHeight;
}

// Schedule Functions

// Global variables
let currentlyEditingScheduleId = null;

// Initialize scheduling system
function initScheduling() {
    resetScheduleForm();
    loadScheduledEvents();

    // Add event listeners
    elements.scheduleIrrigation.addEventListener('click', handleScheduleAction);

    const cancelBtn = document.getElementById('cancel-schedule');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', resetScheduleForm);
    }
}

// Set default schedule time (next hour)
function setDefaultScheduleTime() {
    const now = new Date();
    const nextHour = new Date(now.getTime() + 60 * 60 * 1000);

    // Set default date (today)
    elements.scheduleDate.valueAsDate = now;

    // Set default time (next hour)
    elements.scheduleTime.value = `${String(nextHour.getHours()).padStart(2, '0')}:${String(nextHour.getMinutes()).padStart(2, '0')}`;
}

// Reset schedule button to default state
function resetScheduleButton() {
    elements.scheduleIrrigation.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Schedule Irrigation
    `;
    elements.scheduleIrrigation.classList.remove('bg-blue-600', 'hover:bg-blue-700');
    elements.scheduleIrrigation.classList.add('bg-green-600', 'hover:bg-green-700');
}

// Reset form to default empty state
function resetScheduleForm() {
    elements.scheduleDate.value = '';
    elements.scheduleTime.value = '';
    elements.scheduleDuration.value = '';
    currentlyEditingScheduleId = null;
    resetScheduleButton();
}

// Handle schedule action with confirmation
async function handleScheduleAction() {
    const action = currentlyEditingScheduleId ? 'update' : 'create';
    const confirmed = await showConfirmationDialog(
        action === 'update' ? 'Update Schedule' : 'Create New Schedule',
        action === 'update'
            ? 'Are you sure you want to update this irrigation schedule?'
            : 'Are you sure you want to create a new irrigation schedule?'
    );

    if (confirmed) {
        await scheduleIrrigation();
    }
}

// Show confirmation dialog
function showConfirmationDialog(title, message) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-sm w-full">
                <h3 class="text-lg font-bold mb-4">${title}</h3>
                <p class="mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                    <button id="confirm-ok" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirm</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        modal.querySelector('#confirm-ok').addEventListener('click', () => {
            document.body.removeChild(modal);
            resolve(true);
        });

        modal.querySelector('#confirm-cancel').addEventListener('click', () => {
            document.body.removeChild(modal);
            resolve(false);
        });
    });
}


// Load scheduled events from the server
async function loadScheduledEvents() {
    try {
        // Show loading state and container
        elements.scheduledEvents.classList.remove('hidden');
        elements.eventsList.innerHTML = `
            <div class="flex justify-center py-4">
                <svg class="animate-spin h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        `;

        const response = await fetch('/api/schedule/');
        if (!response.ok) throw new Error('Failed to load scheduled events');

        const events = await response.json();
        displayScheduledEvents(events);

    } catch (error) {
        console.error('Error loading scheduled events:', error);
        elements.eventsList.innerHTML = '<div class="text-red-500 py-4 text-center">Error loading scheduled events</div>';
    }
}

// Display scheduled events
function displayScheduledEvents(events) {
    // Always show the container when displaying events
    elements.scheduledEvents.classList.remove('hidden');

    if (!events || events.length === 0) {
        elements.eventsList.innerHTML = '<div class="text-gray-500 py-4 text-center">No scheduled irrigations</div>';
        return;
    }

    elements.eventsList.innerHTML = '';

    // Sort and display events
    events.sort((a, b) => new Date(a.scheduled_time) - new Date(b.scheduled_time));

    const canEdit = canSchedule();

    events.forEach(event => {
        const eventElement = document.createElement('div');
        eventElement.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md mb-2';

        const eventTime = new Date(event.scheduled_time);
        const now = new Date();
        const isPast = eventTime < now;

        const options = {
            timeZone: 'Africa/Nairobi',
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };

        const formattedTime = eventTime.toLocaleString('en-US', options);

        eventElement.innerHTML = `
            <div class="text-sm ${isPast ? 'text-gray-400' : 'text-gray-800'}">
                ${formattedTime} (${event.duration} mins)
                ${isPast ? '<span class="text-xs text-gray-500">(completed)</span>' : ''}
            </div>
            <div class="flex space-x-2">
                <button class="edit-event ${canEdit ? 'text-blue-500 hover:text-blue-700' : 'text-gray-400 cursor-not-allowed'}"
                        data-id="${event.id}"
                        ${canEdit ? '' : 'disabled'}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
                <button class="delete-event ${canEdit ? 'text-red-500 hover:text-red-700' : 'text-gray-400 cursor-not-allowed'}"
                        data-id="${event.id}"
                        ${canEdit ? '' : 'disabled'}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        `;

        elements.eventsList.appendChild(eventElement);
    });

    // Attach event listeners only if editing is allowed
    if (canSchedule()) {
        document.querySelectorAll('.edit-event').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.stopPropagation();
                await editScheduledEvent(button.dataset.id);
            });
        });

        document.querySelectorAll('.delete-event').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.stopPropagation();
                const confirmed = await showConfirmationDialog(
                    'Delete Schedule',
                    'Are you sure you want to delete this irrigation schedule?'
                );
                if (confirmed) {
                    await deleteScheduledEvent(button.dataset.id);
                }
            });
        });
    }
}

// Delete scheduled event
async function deleteScheduledEvent(eventId) {
    try {
        const response = await fetch(`/api/schedule/${eventId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            if (response.status === 404) {
                // Schedule not found - remove it from UI anyway
                loadScheduledEvents();
                showToast('Schedule was already removed', 'info');
                return;
            }
            throw new Error(errorData.error || `Failed to delete: ${response.status}`);
        }

        logUserActivity(`Deleted scheduled irrigation event`);
        showToast('Schedule deleted', 'success');
        loadScheduledEvents();
    } catch (error) {
        console.error('Error deleting schedule:', error);
        logUserActivity(`Failed to delete schedule: ${error.message}`, "error");
        showToast('Failed to delete schedule', 'error');
    } finally {
        hideConfirmationDialog(); // Ensure popup closes
    }
}

// Edit scheduled event
async function editScheduledEvent(eventId) {
    try {
        const response = await fetch(`/api/schedule/${eventId}/`);
        if (!response.ok) throw new Error('Failed to load schedule details');

        const event = await response.json();
        const eventTime = new Date(event.scheduled_time);

        // Set all form values
        elements.scheduleDate.valueAsDate = eventTime;
        elements.scheduleTime.value = `${String(eventTime.getHours()).padStart(2, '0')}:${String(eventTime.getMinutes()).padStart(2, '0')}`;
        elements.scheduleDuration.value = event.duration || 15;

        // Update button to show "Update"
        elements.scheduleIrrigation.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Update Schedule
        `;
        elements.scheduleIrrigation.classList.remove('bg-green-600', 'hover:bg-green-700');
        elements.scheduleIrrigation.classList.add('bg-blue-600', 'hover:bg-blue-700');

        // Store the ID we're editing
        currentlyEditingScheduleId = eventId;

    } catch (error) {
        console.error('Error loading schedule for editing:', error);
        logUserActivity('Failed to load schedule for editing', 'error');
        showToast('Failed to load schedule for editing', 'error');
    }
}

function hideConfirmationDialog() {
    const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
    if (modal) {
        document.body.removeChild(modal);
    }
}

// Check scheduling availability
function canSchedule() {
    return systemState.systemMode === 'manual' && !systemState.emergency;
}

// Schedule or update irrigation
async function scheduleIrrigation() {
    // First check if scheduling is allowed
    if (!canSchedule()) {
        showToast('Scheduling is only available in manual mode when no emergency is active', 'error');
        return;
    }
    // Reset error messages
    elements.dateError.classList.add('hidden');
    elements.timeError.classList.add('hidden');
    elements.durationError.classList.add('hidden');

    // Get input values
    const date = elements.scheduleDate.value;
    const time = elements.scheduleTime.value;
    const duration = elements.scheduleDuration.value;
    const now = new Date();

    // Validate inputs
    let isValid = true;

    if (!date) {
        elements.dateError.textContent = "Date is required";
        elements.dateError.classList.remove('hidden');
        isValid = false;
    }

    if (!time) {
        elements.timeError.textContent = "Time is required";
        elements.timeError.classList.remove('hidden');
        isValid = false;
    }

    if (!duration) {
        elements.durationError.textContent = "Duration is required";
        elements.durationError.classList.remove('hidden');
        isValid = false;
    } else if (isNaN(duration) || duration < 1 || duration > 120) {
        elements.durationError.textContent = "Duration must be between 1-120 minutes";
        elements.durationError.classList.remove('hidden');
        isValid = false;
    }

    if (!isValid) {
        logUserActivity("Attempt to schedule irrigation failed - invalid inputs", "warning");
        return;
    }

    // Create scheduled datetime object in EAT timezone
    const scheduledDateTime = new Date(`${date}T${time}:00.000+03:00`);

    // Validate future time
    if (scheduledDateTime < now) {
        elements.dateError.textContent = "Scheduled time must be in the future";
        elements.dateError.classList.remove('hidden');
        elements.timeError.classList.remove('hidden');
        logUserActivity("Attempt to schedule irrigation failed - time must be in future", "warning");
        return;
    }

    try {
        // Show loading state
        elements.scheduleIrrigation.disabled = true;
        elements.scheduleIrrigation.innerHTML = `
            <svg class="animate-spin h-5 w-5 mr-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
        `;

        // Determine if we're creating or updating
        const isUpdate = currentlyEditingScheduleId !== null;
        const url = isUpdate ? `/api/schedule/${currentlyEditingScheduleId}/` : '/api/schedule/';
        const method = isUpdate ? 'PUT' : 'POST';

        // Make API request
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                scheduled_time: scheduledDateTime.toISOString(),
                duration: duration
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error ${response.status}`);
        }

        const action = isUpdate ? 'updated' : 'scheduled';
        logUserActivity(`Successfully ${action} irrigation for ${scheduledDateTime.toLocaleString()} (${duration} minutes)`);
        showToast(`Irrigation ${action} successfully!`, 'success');

        // Reset form
        resetScheduleForm();
        loadScheduledEvents();

    } catch (error) {
        console.error('Error scheduling irrigation:', error);
        logUserActivity(`Failed to schedule irrigation: ${error.message}`, "error");
        showToast(`Failed to schedule irrigation: ${error.message}`, 'error');
    } finally {
        // Restore button state
        elements.scheduleIrrigation.disabled = false;
        resetScheduleButton();
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initScheduling);

// Export Functions
function showExportModal() {
    elements.exportModal.classList.remove('hidden');
}

function hideExportModal() {
    elements.exportModal.classList.add('hidden');
}

function exportLogsToExcel() {
    let csvContent = "Timestamp,Type,Message\n";
    userActivityLogs.forEach(log => {
        csvContent += `"${log.timestamp.toLocaleString()}","${log.type}","${log.message.replace(/"/g, '""')}"\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `user-activity-logs-${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    hideExportModal();
    logUserActivity("User exported activity logs");
}

// Helper Functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg text-white ${
        type === 'error' ? 'bg-red-500' :
        type === 'success' ? 'bg-green-500' :
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

// System Status Updates
async function fetchSystemStatus() {
    try {
        const response = await fetch('/api/status/');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        const lastUpdate = new Date(data.timestamp);
        const now = new Date();
        const isConnected = (now - lastUpdate) < 60000;
        updateConnectionStatus(isConnected);

        // Update moisture
        if (typeof data.moisture !== 'undefined' && data.moisture !== systemState.moisture) {
            systemState.moisture = data.moisture;
            updateMoistureDisplay(data.moisture);
        }

        // Update threshold
        if (data.threshold && data.threshold !== systemState.threshold) {
            systemState.threshold = data.threshold;
            elements.thresholdSlider.value = systemState.threshold;
            elements.currentThreshold.textContent = `${systemState.threshold}%`;
            elements.currentThresholdDisplay.textContent = `${systemState.threshold}%`;
            updateMoistureBarColor();
        }

        // Update device states
        if (typeof data.pump !== 'undefined') updateDeviceStatus('pump', data.pump);

        // Update system mode
        if (typeof data.system_mode !== 'undefined') {
            systemState.systemMode = data.system_mode ? 'manual' : 'auto';
            updateSystemModeDisplay();
            // Update scheduling UI based on mode
            loadScheduledEvents();
        }

        // Update emergency status
        if (typeof data.emergency !== 'undefined') {
            systemState.emergency = data.emergency;
            elements.emergencyStatus.textContent = data.emergency ? 'ACTIVE' : 'Inactive';
            elements.emergencyStatus.className = data.emergency ? 'font-medium text-red-600' : 'font-medium text-green-600';

            if (data.emergency) {
                elements.manualControlCard.classList.add('hidden');
                // Update scheduling UI when emergency changes
                loadScheduledEvents();
            } else if (systemState.systemMode === 'manual') {
                elements.manualControlCard.classList.remove('hidden');
                // Update scheduling UI when emergency is cleared
                loadScheduledEvents();
            }
        }

        // Update last watering time
        if (data.last_watering) {
            systemState.lastWateringTime = new Date(data.last_watering);
            elements.lastWatering.textContent = systemState.lastWateringTime.toLocaleTimeString();
        }

        // Update last updated time
        systemState.lastUpdated = new Date();
        elements.lastUpdated.textContent = systemState.lastUpdated.toLocaleTimeString();

    } catch (error) {
        console.error('Error fetching system status:', error);
        updateConnectionStatus(false);
    }
}

function updateSchedulingUI() {
    const schedulingCard = document.getElementById('scheduling-card');
    const schedulingForm = document.getElementById('scheduling-form');
    const disabledMessage = document.getElementById('scheduling-disabled-message');
    const canScheduleNow = canSchedule();

    if (canScheduleNow) {
        schedulingCard.classList.remove('scheduling-disabled');
        schedulingForm.classList.remove('hidden');
        disabledMessage.classList.add('hidden');
        elements.scheduleIrrigation.disabled = false;
    } else {
        schedulingCard.classList.add('scheduling-disabled');
        schedulingForm.classList.add('hidden');
        disabledMessage.classList.remove('hidden');
        elements.scheduleIrrigation.disabled = true;
    }
}

// Call this whenever system mode or emergency status changes
function updateSystemModeDisplay() {
    elements.systemMode.textContent = systemState.systemMode.charAt(0).toUpperCase() + systemState.systemMode.slice(1);
    elements.modeButtonText.textContent = systemState.systemMode === 'auto' ? 'Switch to Manual' : 'Switch to Auto';

    if (systemState.systemMode === 'auto') {
        elements.toggleMode.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        elements.toggleMode.classList.add('bg-blue-600', 'hover:bg-blue-700');
        elements.manualControlCard.classList.add('hidden');
    } else {
        elements.toggleMode.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        elements.toggleMode.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        if (!systemState.emergency) {
            elements.manualControlCard.classList.remove('hidden');
        }
    }

    // Update scheduling UI whenever mode changes
    updateSchedulingUI();
    loadScheduledEvents();
}

</script>

<style>
/* Toggle Switch Styles */
.toggle-switch {
    @apply relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
}

.toggle-switch:disabled {
    @apply opacity-50 cursor-not-allowed;
}

.toggle-switch-circle {
    @apply inline-block h-5 w-5 rounded-full bg-white shadow transform transition-transform duration-200;
}

/* Button Styles */
button {
    @apply transition-colors duration-200;
}

button:disabled {
    @apply opacity-50 cursor-not-allowed;
}

/* Input Styles */
input[type="range"] {
    @apply transition-colors duration-200;
}

input[type="date"],
input[type="time"],
input[type="number"] {
    @apply w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200;
}

/* Smooth transitions for all interactive elements */
button, input, select {
    @apply transition-colors duration-200;
}

/* User Activity Logs Styles */
#user-activity-logs {
    scrollbar-width: thin;
    scrollbar-color: rgba(0,0,0,0.1) transparent;
}

#user-activity-logs::-webkit-scrollbar {
    width: 6px;
}

#user-activity-logs::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 3px;
}

/* Modal Styles */
.modal-overlay {
    @apply fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity;
}

.modal-content {
    @apply inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full;
}

/* Toast notifications */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(10px); }
}

.toast {
    animation: fadeIn 0.3s ease-out;
    z-index: 1000;
}

.toast.fade-out {
    animation: fadeOut 0.3s ease-in;
}

.scheduling-disabled {
    opacity: 0.6;
    pointer-events: none;
}

.scheduling-disabled-message {
    @apply text-sm text-red-600 mt-2;
}

</style>

{% endblock %}
